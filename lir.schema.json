{
	"$schema": "https://json-schema.org/draft/2020-12/schema",
	"$id": "https://raw.githubusercontent.com/Mearman/SPIRAL/refs/heads/main/lir.schema.json",
	"$defs": {
		"LirInsAssign": {
			"type": "object",
			"properties": {
				"kind": {
					"type": "string",
					"const": "assign"
				},
				"target": {
					"type": "string"
				},
				"value": {
					"anyOf": [
						{
							"$ref": "spiral.schema.json#/$defs/LitExpr"
						},
						{
							"$ref": "spiral.schema.json#/$defs/RefExpr"
						},
						{
							"$ref": "spiral.schema.json#/$defs/VarExpr"
						},
						{
							"$ref": "spiral.schema.json#/$defs/CallExpr"
						},
						{
							"$ref": "spiral.schema.json#/$defs/IfExpr"
						},
						{
							"$ref": "spiral.schema.json#/$defs/LetExpr"
						},
						{
							"$ref": "spiral.schema.json#/$defs/AirRefExpr"
						},
						{
							"$ref": "spiral.schema.json#/$defs/PredicateExpr"
						},
						{
							"type": "object",
							"properties": {
								"type": {
									"$ref": "spiral.schema.json#/$defs/Type"
								},
								"body": {
									"type": "string"
								},
								"kind": {
									"type": "string",
									"const": "lambda"
								},
								"params": {
									"type": "array",
									"items": {
										"anyOf": [
											{
												"type": "string"
											},
											{
												"type": "object",
												"properties": {
													"type": {
														"$ref": "spiral.schema.json#/$defs/Type"
													},
													"default": {
														"$ref": "spiral.schema.json#/$defs/Expr"
													},
													"name": {
														"type": "string"
													},
													"optional": {
														"type": "boolean"
													}
												},
												"additionalProperties": false,
												"required": [
													"name"
												]
											}
										]
									}
								}
							},
							"additionalProperties": false,
							"required": [
								"kind",
								"params",
								"body",
								"type"
							]
						},
						{
							"type": "object",
							"properties": {
								"args": {
									"type": "array",
									"items": {
										"anyOf": [
											{
												"type": "string"
											},
											{
												"$ref": "spiral.schema.json#/$defs/Expr"
											}
										]
									}
								},
								"fn": {
									"type": "string"
								},
								"kind": {
									"type": "string",
									"const": "callExpr"
								}
							},
							"additionalProperties": false,
							"required": [
								"kind",
								"fn",
								"args"
							]
						},
						{
							"type": "object",
							"properties": {
								"type": {
									"$ref": "spiral.schema.json#/$defs/Type"
								},
								"fn": {
									"type": "string"
								},
								"kind": {
									"type": "string",
									"const": "fix"
								}
							},
							"additionalProperties": false,
							"required": [
								"kind",
								"fn",
								"type"
							]
						},
						{
							"type": "object",
							"properties": {
								"exprs": {
									"type": "array",
									"items": {
										"anyOf": [
											{
												"type": "string"
											},
											{
												"$ref": "spiral.schema.json#/$defs/Expr"
											}
										]
									}
								},
								"kind": {
									"type": "string",
									"const": "do"
								}
							},
							"additionalProperties": false,
							"required": [
								"kind",
								"exprs"
							]
						}
					]
				}
			},
			"additionalProperties": false,
			"required": [
				"kind",
				"target",
				"value"
			],
			"id": "LirInsAssign"
		},
		"LirInsOp": {
			"type": "object",
			"properties": {
				"args": {
					"type": "array",
					"items": {
						"type": "string"
					}
				},
				"kind": {
					"type": "string",
					"const": "op"
				},
				"name": {
					"type": "string"
				},
				"ns": {
					"type": "string"
				},
				"target": {
					"type": "string"
				}
			},
			"additionalProperties": false,
			"required": [
				"kind",
				"target",
				"ns",
				"name",
				"args"
			],
			"id": "LirInsOp"
		}
	},
	"title": "LIR (Low-Level IR)",
	"description": "LIRDocument",
	"type": "object",
	"properties": {
		"airDefs": {
			"type": "array",
			"items": {
				"$ref": "spiral.schema.json#/$defs/AIRDef"
			}
		},
		"capabilities": {
			"type": "array",
			"items": {
				"type": "string"
			}
		},
		"functionSigs": {
			"type": "array",
			"items": {
				"$ref": "spiral.schema.json#/$defs/FunctionSignature"
			}
		},
		"nodes": {
			"type": "array",
			"items": {
				"anyOf": [
					{
						"type": "object",
						"properties": {
							"type": {
								"$ref": "spiral.schema.json#/$defs/Type"
							},
							"expr": {
								"anyOf": [
									{
										"$ref": "spiral.schema.json#/$defs/LitExpr"
									},
									{
										"$ref": "spiral.schema.json#/$defs/RefExpr"
									},
									{
										"$ref": "spiral.schema.json#/$defs/VarExpr"
									},
									{
										"$ref": "spiral.schema.json#/$defs/CallExpr"
									},
									{
										"$ref": "spiral.schema.json#/$defs/IfExpr"
									},
									{
										"$ref": "spiral.schema.json#/$defs/LetExpr"
									},
									{
										"$ref": "spiral.schema.json#/$defs/AirRefExpr"
									},
									{
										"$ref": "spiral.schema.json#/$defs/PredicateExpr"
									},
									{
										"type": "object",
										"properties": {
											"type": {
												"$ref": "spiral.schema.json#/$defs/Type"
											},
											"body": {
												"type": "string"
											},
											"kind": {
												"type": "string",
												"const": "lambda"
											},
											"params": {
												"type": "array",
												"items": {
													"anyOf": [
														{
															"type": "string"
														},
														{
															"type": "object",
															"properties": {
																"type": {
																	"$ref": "spiral.schema.json#/$defs/Type"
																},
																"default": {
																	"$ref": "spiral.schema.json#/$defs/Expr"
																},
																"name": {
																	"type": "string"
																},
																"optional": {
																	"type": "boolean"
																}
															},
															"additionalProperties": false,
															"required": [
																"name"
															]
														}
													]
												}
											}
										},
										"additionalProperties": false,
										"required": [
											"kind",
											"params",
											"body",
											"type"
										]
									},
									{
										"type": "object",
										"properties": {
											"args": {
												"type": "array",
												"items": {
													"anyOf": [
														{
															"type": "string"
														},
														{
															"$ref": "spiral.schema.json#/$defs/Expr"
														}
													]
												}
											},
											"fn": {
												"type": "string"
											},
											"kind": {
												"type": "string",
												"const": "callExpr"
											}
										},
										"additionalProperties": false,
										"required": [
											"kind",
											"fn",
											"args"
										]
									},
									{
										"type": "object",
										"properties": {
											"type": {
												"$ref": "spiral.schema.json#/$defs/Type"
											},
											"fn": {
												"type": "string"
											},
											"kind": {
												"type": "string",
												"const": "fix"
											}
										},
										"additionalProperties": false,
										"required": [
											"kind",
											"fn",
											"type"
										]
									},
									{
										"type": "object",
										"properties": {
											"exprs": {
												"type": "array",
												"items": {
													"anyOf": [
														{
															"type": "string"
														},
														{
															"$ref": "spiral.schema.json#/$defs/Expr"
														}
													]
												}
											},
											"kind": {
												"type": "string",
												"const": "do"
											}
										},
										"additionalProperties": false,
										"required": [
											"kind",
											"exprs"
										]
									}
								]
							},
							"id": {
								"type": "string"
							}
						},
						"additionalProperties": false,
						"required": [
							"id",
							"expr"
						]
					},
					{
						"type": "object",
						"properties": {
							"type": {
								"$ref": "spiral.schema.json#/$defs/Type"
							},
							"blocks": {
								"type": "array",
								"items": {
									"type": "object",
									"properties": {
										"id": {
											"type": "string"
										},
										"instructions": {
											"type": "array",
											"items": {
												"anyOf": [
													{
														"$ref": "#/$defs/LirInsAssign"
													},
													{
														"type": "object",
														"properties": {
															"args": {
																"type": "array",
																"items": {
																	"type": "string"
																}
															},
															"callee": {
																"type": "string"
															},
															"kind": {
																"type": "string",
																"const": "call"
															},
															"target": {
																"type": "string"
															}
														},
														"additionalProperties": false,
														"required": [
															"kind",
															"target",
															"callee",
															"args"
														]
													},
													{
														"$ref": "#/$defs/LirInsOp"
													},
													{
														"$ref": "spiral.schema.json#/$defs/LirInsPhi"
													},
													{
														"type": "object",
														"properties": {
															"args": {
																"type": "array",
																"items": {
																	"type": "string"
																}
															},
															"kind": {
																"type": "string",
																"const": "effect"
															},
															"op": {
																"type": "string"
															},
															"target": {
																"type": "string"
															}
														},
														"additionalProperties": false,
														"required": [
															"kind",
															"op",
															"args"
														]
													},
													{
														"type": "object",
														"properties": {
															"kind": {
																"type": "string",
																"const": "assignRef"
															},
															"target": {
																"type": "string"
															},
															"value": {
																"type": "string"
															}
														},
														"additionalProperties": false,
														"required": [
															"kind",
															"target",
															"value"
														]
													}
												]
											}
										},
										"terminator": {
											"anyOf": [
												{
													"$ref": "spiral.schema.json#/$defs/LirTermJump"
												},
												{
													"$ref": "spiral.schema.json#/$defs/LirTermBranch"
												},
												{
													"$ref": "spiral.schema.json#/$defs/LirTermReturn"
												},
												{
													"$ref": "spiral.schema.json#/$defs/LirTermExit"
												},
												{
													"type": "object",
													"properties": {
														"branches": {
															"type": "array",
															"items": {
																"type": "object",
																"properties": {
																	"block": {
																		"type": "string"
																	},
																	"taskId": {
																		"type": "string"
																	}
																},
																"additionalProperties": false,
																"required": [
																	"block",
																	"taskId"
																]
															}
														},
														"continuation": {
															"type": "string"
														},
														"kind": {
															"type": "string",
															"const": "fork"
														}
													},
													"additionalProperties": false,
													"required": [
														"kind",
														"branches",
														"continuation"
													]
												},
												{
													"type": "object",
													"properties": {
														"kind": {
															"type": "string",
															"const": "join"
														},
														"results": {
															"type": "array",
															"items": {
																"type": "string"
															}
														},
														"tasks": {
															"type": "array",
															"items": {
																"type": "string"
															}
														},
														"to": {
															"type": "string"
														}
													},
													"additionalProperties": false,
													"required": [
														"kind",
														"tasks",
														"to"
													]
												},
												{
													"type": "object",
													"properties": {
														"future": {
															"type": "string"
														},
														"kind": {
															"type": "string",
															"const": "suspend"
														},
														"resumeBlock": {
															"type": "string"
														}
													},
													"additionalProperties": false,
													"required": [
														"kind",
														"future",
														"resumeBlock"
													]
												}
											]
										}
									},
									"additionalProperties": false,
									"required": [
										"id",
										"instructions",
										"terminator"
									]
								}
							},
							"entry": {
								"type": "string"
							},
							"id": {
								"type": "string"
							}
						},
						"additionalProperties": false,
						"required": [
							"id",
							"blocks",
							"entry"
						]
					}
				]
			}
		},
		"result": {
			"type": "string"
		},
		"version": {
			"type": "string",
			"pattern": "^\\d+\\.\\d+\\.\\d+(-[a-zA-Z0-9.]+)?$"
		}
	},
	"additionalProperties": false,
	"required": [
		"version",
		"nodes",
		"result"
	]
}

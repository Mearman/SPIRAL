{
	"$schema": "https://raw.githubusercontent.com/Mearman/SPIRAL/main/cir.schema.json",
	"version": "1.0.0",
	"description": "Meta-circular evaluator v2: recursive eval(input, env) dispatches on core:typeof â€” string inputs resolve node references, map inputs evaluate expressions. Handles lit, ref, call, if with 13 operators. Target: 10 + 20 = 30.",
	"airDefs": [],
	"nodes": [
		{"id": "zero", "expr": {"kind": "lit", "type": {"kind": "int"}, "value": 0}},
		{"id": "one",  "expr": {"kind": "lit", "type": {"kind": "int"}, "value": 1}},
		{"id": "two",  "expr": {"kind": "lit", "type": {"kind": "int"}, "value": 2}},

		{"id": "kindKey",  "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "kind"}},
		{"id": "valueKey", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "value"}},
		{"id": "idKey",    "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "id"}},
		{"id": "exprKey",  "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "expr"}},
		{"id": "nsKey",    "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "ns"}},
		{"id": "nameKey",  "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "name"}},
		{"id": "argsKey",  "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "args"}},
		{"id": "condKey",  "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "cond"}},
		{"id": "thenKey",  "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "then"}},
		{"id": "elseKey",  "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "else"}},

		{"id": "stringTypeStr", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "string"}},

		{"id": "litStr",  "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "lit"}},
		{"id": "refStr",  "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "ref"}},
		{"id": "callStr", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "call"}},
		{"id": "ifStr",   "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "if"}},

		{"id": "coreStr", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "core"}},
		{"id": "boolStr", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "bool"}},

		{"id": "addStr", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "add"}},
		{"id": "subStr", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "sub"}},
		{"id": "mulStr", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "mul"}},
		{"id": "divStr", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "div"}},
		{"id": "modStr", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "mod"}},
		{"id": "negStr", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "neg"}},
		{"id": "eqStr",  "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "eq"}},
		{"id": "neqStr", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "neq"}},
		{"id": "ltStr",  "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "lt"}},
		{"id": "lteStr", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "lte"}},
		{"id": "gtStr",  "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "gt"}},
		{"id": "gteStr", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "gte"}},
		{"id": "notStr", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "not"}},

		{"id": "targetIdA", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "a"}},
		{"id": "targetValA", "expr": {"kind": "lit", "type": {"kind": "int"}, "value": 10}},
		{"id": "targetExprA", "expr": {"kind": "record", "fields": [
			{"key": "kind", "value": "litStr"},
			{"key": "value", "value": "targetValA"}
		]}},
		{"id": "targetNodeA", "expr": {"kind": "record", "fields": [
			{"key": "id", "value": "targetIdA"},
			{"key": "expr", "value": "targetExprA"}
		]}},

		{"id": "targetIdB", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "b"}},
		{"id": "targetValB", "expr": {"kind": "lit", "type": {"kind": "int"}, "value": 20}},
		{"id": "targetExprB", "expr": {"kind": "record", "fields": [
			{"key": "kind", "value": "litStr"},
			{"key": "value", "value": "targetValB"}
		]}},
		{"id": "targetNodeB", "expr": {"kind": "record", "fields": [
			{"key": "id", "value": "targetIdB"},
			{"key": "expr", "value": "targetExprB"}
		]}},

		{"id": "targetIdSum", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "sum"}},
		{"id": "argIdA", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "a"}},
		{"id": "argIdB", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "b"}},
		{"id": "targetArgsList", "expr": {"kind": "listOf", "elements": ["argIdA", "argIdB"]}},
		{"id": "targetExprSum", "expr": {"kind": "record", "fields": [
			{"key": "kind", "value": "callStr"},
			{"key": "ns", "value": "coreStr"},
			{"key": "name", "value": "addStr"},
			{"key": "args", "value": "targetArgsList"}
		]}},
		{"id": "targetNodeSum", "expr": {"kind": "record", "fields": [
			{"key": "id", "value": "targetIdSum"},
			{"key": "expr", "value": "targetExprSum"}
		]}},

		{"id": "targetNodes", "expr": {"kind": "listOf", "elements": ["targetNodeA", "targetNodeB", "targetNodeSum"]}},
		{"id": "targetResult", "expr": {"kind": "lit", "type": {"kind": "string"}, "value": "sum"}},

		{"id": "emptyMap", "expr": {"kind": "record", "fields": []}},

		{"id": "nodeCount", "expr": {"kind": "call", "ns": "list", "name": "length", "args": ["targetNodes"]}},

		{"id": "bmIdxVar", "expr": {"kind": "var", "name": "bmIdx"}},
		{"id": "bmAccVar", "expr": {"kind": "var", "name": "bmAcc"}},
		{"id": "bmRecVar", "expr": {"kind": "var", "name": "bmRec"}},

		{"id": "bmCurNode", "expr": {"kind": "call", "ns": "list", "name": "nth",  "args": ["targetNodes", "bmIdxVar"]}},
		{"id": "bmCurId",   "expr": {"kind": "call", "ns": "map",  "name": "get",  "args": ["bmCurNode", "idKey"]}},
		{"id": "bmNextAcc", "expr": {"kind": "call", "ns": "map",  "name": "set",  "args": ["bmAccVar", "bmCurId", "bmCurNode"]}},
		{"id": "bmNextIdx", "expr": {"kind": "call", "ns": "core", "name": "add",  "args": ["bmIdxVar", "one"]}},
		{"id": "bmRecurse", "expr": {"kind": "callExpr", "args": ["bmNextIdx", "bmNextAcc"], "fn": "bmRecVar"}},
		{"id": "bmIsDone",  "expr": {"kind": "call", "ns": "core", "name": "gte",  "args": ["bmIdxVar", "nodeCount"]}},
		{"id": "bmBody", "expr": {
			"kind": "if",
			"type": {"kind": "int"},
			"cond": "bmIsDone",
			"then": "bmAccVar",
			"else": "bmRecurse"
		}},

		{"id": "bmInner", "expr": {
			"kind": "lambda",
			"type": {
				"kind": "fn",
				"params": [{"kind": "int"}, {"kind": "map", "key": {"kind": "string"}, "value": {"kind": "int"}}],
				"returns": {"kind": "map", "key": {"kind": "string"}, "value": {"kind": "int"}}
			},
			"params": ["bmIdx", "bmAcc"],
			"body": "bmBody"
		}},
		{"id": "bmOuter", "expr": {
			"kind": "lambda",
			"type": {
				"kind": "fn",
				"params": [{"kind": "fn", "params": [{"kind": "int"}, {"kind": "map", "key": {"kind": "string"}, "value": {"kind": "int"}}], "returns": {"kind": "map", "key": {"kind": "string"}, "value": {"kind": "int"}}}],
				"returns": {"kind": "fn", "params": [{"kind": "int"}, {"kind": "map", "key": {"kind": "string"}, "value": {"kind": "int"}}], "returns": {"kind": "map", "key": {"kind": "string"}, "value": {"kind": "int"}}}
			},
			"params": ["bmRec"],
			"body": "bmInner"
		}},
		{"id": "buildNm", "expr": {
			"kind": "fix",
			"type": {
				"kind": "fn",
				"params": [{"kind": "int"}, {"kind": "map", "key": {"kind": "string"}, "value": {"kind": "int"}}],
				"returns": {"kind": "map", "key": {"kind": "string"}, "value": {"kind": "int"}}
			},
			"fn": "bmOuter"
		}},
		{"id": "nodeMap", "expr": {"kind": "callExpr", "args": ["zero", "emptyMap"], "fn": "buildNm"}},

		{"id": "inputVar", "expr": {"kind": "var", "name": "input"}},
		{"id": "envVar",   "expr": {"kind": "var", "name": "env"}},
		{"id": "recVar",   "expr": {"kind": "var", "name": "rec"}},

		{"id": "inputType", "expr": {"kind": "call", "ns": "core", "name": "typeof", "args": ["inputVar"]}},
		{"id": "isString",  "expr": {"kind": "call", "ns": "core", "name": "eq", "args": ["inputType", "stringTypeStr"]}},

		{"id": "hasInEnv",     "expr": {"kind": "call", "ns": "map",  "name": "has", "args": ["envVar", "inputVar"]}},
		{"id": "envValue",     "expr": {"kind": "call", "ns": "map",  "name": "get", "args": ["envVar", "inputVar"]}},
		{"id": "nodeRec",      "expr": {"kind": "call", "ns": "map",  "name": "get", "args": ["nodeMap", "inputVar"]}},
		{"id": "nodeExpr",     "expr": {"kind": "call", "ns": "map",  "name": "get", "args": ["nodeRec", "exprKey"]}},
		{"id": "lookupResult", "expr": {"kind": "callExpr", "args": ["nodeExpr", "envVar"], "fn": "recVar"}},
		{"id": "envOrLookup",  "expr": {
			"kind": "if",
			"type": {"kind": "int"},
			"cond": "hasInEnv",
			"then": "envValue",
			"else": "lookupResult"
		}},

		{"id": "exprKind", "expr": {"kind": "call", "ns": "map", "name": "get", "args": ["inputVar", "kindKey"]}},

		{"id": "litValue", "expr": {"kind": "call", "ns": "map", "name": "get", "args": ["inputVar", "valueKey"]}},

		{"id": "refId",     "expr": {"kind": "call", "ns": "map",  "name": "get", "args": ["inputVar", "idKey"]}},
		{"id": "refResult", "expr": {"kind": "callExpr", "args": ["refId", "envVar"], "fn": "recVar"}},

		{"id": "callNs",   "expr": {"kind": "call", "ns": "map",  "name": "get", "args": ["inputVar", "nsKey"]}},
		{"id": "callName", "expr": {"kind": "call", "ns": "map",  "name": "get", "args": ["inputVar", "nameKey"]}},
		{"id": "callArgs", "expr": {"kind": "call", "ns": "map",  "name": "get", "args": ["inputVar", "argsKey"]}},
		{"id": "arg0Id",   "expr": {"kind": "call", "ns": "list", "name": "nth", "args": ["callArgs", "zero"]}},
		{"id": "arg0Val",  "expr": {"kind": "callExpr", "args": ["arg0Id", "envVar"], "fn": "recVar"}},
		{"id": "arg1Id",   "expr": {"kind": "call", "ns": "list", "name": "nth", "args": ["callArgs", "one"]}},
		{"id": "arg1Val",  "expr": {"kind": "callExpr", "args": ["arg1Id", "envVar"], "fn": "recVar"}},

		{"id": "dispatchAdd", "expr": {"kind": "call", "ns": "core", "name": "add", "args": ["arg0Val", "arg1Val"]}},
		{"id": "dispatchSub", "expr": {"kind": "call", "ns": "core", "name": "sub", "args": ["arg0Val", "arg1Val"]}},
		{"id": "dispatchMul", "expr": {"kind": "call", "ns": "core", "name": "mul", "args": ["arg0Val", "arg1Val"]}},
		{"id": "dispatchDiv", "expr": {"kind": "call", "ns": "core", "name": "div", "args": ["arg0Val", "arg1Val"]}},
		{"id": "dispatchMod", "expr": {"kind": "call", "ns": "core", "name": "mod", "args": ["arg0Val", "arg1Val"]}},
		{"id": "dispatchNeg", "expr": {"kind": "call", "ns": "core", "name": "neg", "args": ["arg0Val"]}},
		{"id": "dispatchEq",  "expr": {"kind": "call", "ns": "core", "name": "eq",  "args": ["arg0Val", "arg1Val"]}},
		{"id": "dispatchNeq", "expr": {"kind": "call", "ns": "core", "name": "neq", "args": ["arg0Val", "arg1Val"]}},
		{"id": "dispatchLt",  "expr": {"kind": "call", "ns": "core", "name": "lt",  "args": ["arg0Val", "arg1Val"]}},
		{"id": "dispatchLte", "expr": {"kind": "call", "ns": "core", "name": "lte", "args": ["arg0Val", "arg1Val"]}},
		{"id": "dispatchGt",  "expr": {"kind": "call", "ns": "core", "name": "gt",  "args": ["arg0Val", "arg1Val"]}},
		{"id": "dispatchGte", "expr": {"kind": "call", "ns": "core", "name": "gte", "args": ["arg0Val", "arg1Val"]}},
		{"id": "dispatchNot", "expr": {"kind": "call", "ns": "bool", "name": "not", "args": ["arg0Val"]}},

		{
			"id": "coreDispatch", "expr": {
				"kind": "match",
				"value": "callName",
				"cases": [
					{ "body": "dispatchAdd","pattern": "add"},
					{ "body": "dispatchSub","pattern": "sub"},
					{ "body": "dispatchMul","pattern": "mul"},
					{ "body": "dispatchDiv","pattern": "div"},
					{ "body": "dispatchMod","pattern": "mod"},
					{ "body": "dispatchNeg","pattern": "neg"},
					{  "body": "dispatchEq","pattern": "eq"},
					{ "body": "dispatchNeq","pattern": "neq"},
					{  "body": "dispatchLt","pattern": "lt"},
					{ "body": "dispatchLte","pattern": "lte"},
					{  "body": "dispatchGt","pattern": "gt"},
					{ "body": "dispatchGte","pattern": "gte"}
				],
				"default": "zero"
			}
		},
		{
			"id": "boolDispatch", "expr": {
				"kind": "match",
				"value": "callName",
				"cases": [
					{ "body": "dispatchNot","pattern": "not"}
				],
				"default": "zero"
			}
		},
		{
			"id": "callResult", "expr": {
				"kind": "match",
				"value": "callNs",
				"cases": [
					{ "body": "coreDispatch","pattern": "core"},
					{ "body": "boolDispatch","pattern": "bool"}
				],
				"default": "zero"
			}
		},

		{"id": "ifCondRef", "expr": {"kind": "call", "ns": "map", "name": "get", "args": ["inputVar", "condKey"]}},
		{"id": "ifCondVal", "expr": {"kind": "callExpr", "args": ["ifCondRef", "envVar"], "fn": "recVar"}},
		{"id": "ifThenRef", "expr": {"kind": "call", "ns": "map", "name": "get", "args": ["inputVar", "thenKey"]}},
		{"id": "ifElseRef", "expr": {"kind": "call", "ns": "map", "name": "get", "args": ["inputVar", "elseKey"]}},
		{"id": "ifThenVal", "expr": {"kind": "callExpr", "args": ["ifThenRef", "envVar"], "fn": "recVar"}},
		{"id": "ifElseVal", "expr": {"kind": "callExpr", "args": ["ifElseRef", "envVar"], "fn": "recVar"}},
		{
			"id": "ifResult", "expr": {
				"kind": "if",
				"type": {"kind": "int"},
				"cond": "ifCondVal",
				"then": "ifThenVal",
				"else": "ifElseVal"
			}
		},

		{
			"id": "exprResult", "expr": {
				"kind": "match",
				"value": "exprKind",
				"cases": [
					{  "body": "litValue","pattern": "lit"},
					{  "body": "refResult","pattern": "ref"},
					{ "body": "callResult","pattern": "call"},
					{   "body": "ifResult","pattern": "if"}
				],
				"default": "zero"
			}
		},

		{
			"id": "evalBody", "expr": {
				"kind": "if",
				"type": {"kind": "int"},
				"cond": "isString",
				"then": "envOrLookup",
				"else": "exprResult"
			}
		},

		{"id": "evalInner", "expr": {
			"kind": "lambda",
			"type": {
				"kind": "fn",
				"params": [{"kind": "int"}, {"kind": "map", "key": {"kind": "string"}, "value": {"kind": "int"}}],
				"returns": {"kind": "int"}
			},
			"params": ["input", "env"],
			"body": "evalBody"
		}},
		{"id": "evalOuter", "expr": {
			"kind": "lambda",
			"type": {
				"kind": "fn",
				"params": [{"kind": "fn", "params": [{"kind": "int"}, {"kind": "map", "key": {"kind": "string"}, "value": {"kind": "int"}}], "returns": {"kind": "int"}}],
				"returns": {"kind": "fn", "params": [{"kind": "int"}, {"kind": "map", "key": {"kind": "string"}, "value": {"kind": "int"}}], "returns": {"kind": "int"}}
			},
			"params": ["rec"],
			"body": "evalInner"
		}},
		{"id": "evalFn", "expr": {
			"kind": "fix",
			"type": {
				"kind": "fn",
				"params": [{"kind": "int"}, {"kind": "map", "key": {"kind": "string"}, "value": {"kind": "int"}}],
				"returns": {"kind": "int"}
			},
			"fn": "evalOuter"
		}},

		{"id": "result", "expr": {"kind": "callExpr", "args": ["targetResult", "emptyMap"], "fn": "evalFn"}}
	],
	"result": "result",
	"expected_result": 30
}

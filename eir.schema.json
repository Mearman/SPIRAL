{
	"$schema": "https://json-schema.org/draft/2020-12/schema",
	"$id": "https://raw.githubusercontent.com/Mearman/SPIRAL/refs/heads/main/eir.schema.json",
	"$defs": {
		"EirExpr": {
			"anyOf": [
				{
					"$ref": "spiral.schema.json#/$defs/LitExpr"
				},
				{
					"$ref": "spiral.schema.json#/$defs/RefExpr"
				},
				{
					"$ref": "spiral.schema.json#/$defs/VarExpr"
				},
				{
					"$ref": "spiral.schema.json#/$defs/CallExpr"
				},
				{
					"$ref": "spiral.schema.json#/$defs/IfExpr"
				},
				{
					"$ref": "spiral.schema.json#/$defs/LetExpr"
				},
				{
					"$ref": "spiral.schema.json#/$defs/AirRefExpr"
				},
				{
					"$ref": "spiral.schema.json#/$defs/PredicateExpr"
				},
				{
					"type": "object",
					"properties": {
						"type": {
							"$ref": "spiral.schema.json#/$defs/Type"
						},
						"body": {
							"type": "string"
						},
						"kind": {
							"type": "string",
							"const": "lambda"
						},
						"params": {
							"type": "array",
							"items": {
								"anyOf": [
									{
										"type": "string"
									},
									{
										"type": "object",
										"properties": {
											"type": {
												"$ref": "spiral.schema.json#/$defs/Type"
											},
											"default": {
												"$ref": "spiral.schema.json#/$defs/Expr"
											},
											"name": {
												"type": "string"
											},
											"optional": {
												"type": "boolean"
											}
										},
										"additionalProperties": false,
										"required": [
											"name"
										]
									}
								]
							}
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"params",
						"body",
						"type"
					]
				},
				{
					"type": "object",
					"properties": {
						"args": {
							"type": "array",
							"items": {
								"anyOf": [
									{
										"type": "string"
									},
									{
										"$ref": "spiral.schema.json#/$defs/Expr"
									}
								]
							}
						},
						"fn": {
							"type": "string"
						},
						"kind": {
							"type": "string",
							"const": "callExpr"
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"fn",
						"args"
					]
				},
				{
					"type": "object",
					"properties": {
						"type": {
							"$ref": "spiral.schema.json#/$defs/Type"
						},
						"fn": {
							"type": "string"
						},
						"kind": {
							"type": "string",
							"const": "fix"
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"fn",
						"type"
					]
				},
				{
					"type": "object",
					"properties": {
						"exprs": {
							"type": "array",
							"items": {
								"anyOf": [
									{
										"type": "string"
									},
									{
										"$ref": "spiral.schema.json#/$defs/Expr"
									}
								]
							}
						},
						"kind": {
							"type": "string",
							"const": "do"
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"exprs"
					]
				},
				{
					"type": "object",
					"properties": {
						"first": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						},
						"kind": {
							"type": "string",
							"const": "seq"
						},
						"then": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"first",
						"then"
					]
				},
				{
					"type": "object",
					"properties": {
						"kind": {
							"type": "string",
							"const": "assign"
						},
						"target": {
							"type": "string"
						},
						"value": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"target",
						"value"
					]
				},
				{
					"type": "object",
					"properties": {
						"body": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						},
						"cond": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						},
						"kind": {
							"type": "string",
							"const": "while"
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"cond",
						"body"
					]
				},
				{
					"type": "object",
					"properties": {
						"body": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						},
						"cond": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						},
						"init": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						},
						"kind": {
							"type": "string",
							"const": "for"
						},
						"update": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						},
						"var": {
							"type": "string"
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"var",
						"init",
						"cond",
						"update",
						"body"
					]
				},
				{
					"type": "object",
					"properties": {
						"body": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						},
						"iter": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						},
						"kind": {
							"type": "string",
							"const": "iter"
						},
						"var": {
							"type": "string"
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"var",
						"iter",
						"body"
					]
				},
				{
					"type": "object",
					"properties": {
						"args": {
							"type": "array",
							"items": {
								"anyOf": [
									{
										"type": "string"
									},
									{
										"$ref": "spiral.schema.json#/$defs/Expr"
									}
								]
							}
						},
						"kind": {
							"type": "string",
							"const": "effect"
						},
						"op": {
							"type": "string"
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"op",
						"args"
					]
				},
				{
					"type": "object",
					"properties": {
						"kind": {
							"type": "string",
							"const": "refCell"
						},
						"target": {
							"type": "string"
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"target"
					]
				},
				{
					"type": "object",
					"properties": {
						"kind": {
							"type": "string",
							"const": "deref"
						},
						"target": {
							"type": "string"
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"target"
					]
				},
				{
					"type": "object",
					"properties": {
						"catchBody": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						},
						"catchParam": {
							"type": "string"
						},
						"fallback": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						},
						"kind": {
							"type": "string",
							"const": "try"
						},
						"tryBody": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"tryBody",
						"catchParam",
						"catchBody"
					]
				},
				{
					"type": "object",
					"properties": {
						"branches": {
							"type": "array",
							"items": {
								"type": "string"
							}
						},
						"kind": {
							"type": "string",
							"const": "par"
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"branches"
					]
				},
				{
					"type": "object",
					"properties": {
						"kind": {
							"type": "string",
							"const": "spawn"
						},
						"task": {
							"type": "string"
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"task"
					]
				},
				{
					"type": "object",
					"properties": {
						"fallback": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						},
						"future": {
							"type": "string"
						},
						"kind": {
							"type": "string",
							"const": "await"
						},
						"returnIndex": {
							"type": "boolean"
						},
						"timeout": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"future"
					]
				},
				{
					"type": "object",
					"properties": {
						"bufferSize": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						},
						"channelType": {
							"type": "string",
							"enum": [
								"mpsc",
								"spsc",
								"mpmc",
								"broadcast"
							]
						},
						"kind": {
							"type": "string",
							"const": "channel"
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"channelType"
					]
				},
				{
					"type": "object",
					"properties": {
						"channel": {
							"type": "string"
						},
						"kind": {
							"type": "string",
							"const": "send"
						},
						"value": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"channel",
						"value"
					]
				},
				{
					"type": "object",
					"properties": {
						"channel": {
							"type": "string"
						},
						"kind": {
							"type": "string",
							"const": "recv"
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"channel"
					]
				},
				{
					"type": "object",
					"properties": {
						"fallback": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						},
						"futures": {
							"type": "array",
							"items": {
								"type": "string"
							}
						},
						"kind": {
							"type": "string",
							"const": "select"
						},
						"returnIndex": {
							"type": "boolean"
						},
						"timeout": {
							"anyOf": [
								{
									"type": "string"
								},
								{
									"$ref": "spiral.schema.json#/$defs/Expr"
								}
							]
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"futures"
					]
				},
				{
					"type": "object",
					"properties": {
						"kind": {
							"type": "string",
							"const": "race"
						},
						"tasks": {
							"type": "array",
							"items": {
								"type": "string"
							}
						}
					},
					"additionalProperties": false,
					"required": [
						"kind",
						"tasks"
					]
				}
			],
			"id": "EirExpr"
		}
	},
	"title": "EIR (Execution IR)",
	"description": "EIRDocument",
	"type": "object",
	"properties": {
		"airDefs": {
			"type": "array",
			"items": {
				"$ref": "spiral.schema.json#/$defs/AIRDef"
			}
		},
		"capabilities": {
			"type": "array",
			"items": {
				"type": "string"
			}
		},
		"functionSigs": {
			"type": "array",
			"items": {
				"$ref": "spiral.schema.json#/$defs/FunctionSignature"
			}
		},
		"nodes": {
			"type": "array",
			"items": {
				"anyOf": [
					{
						"type": "object",
						"properties": {
							"type": {
								"$ref": "spiral.schema.json#/$defs/Type"
							},
							"expr": {
								"$ref": "#/$defs/EirExpr"
							},
							"id": {
								"type": "string"
							}
						},
						"additionalProperties": false,
						"required": [
							"id",
							"expr"
						]
					},
					{
						"type": "object",
						"properties": {
							"type": {
								"$ref": "spiral.schema.json#/$defs/Type"
							},
							"blocks": {
								"type": "array",
								"items": {
									"type": "object",
									"properties": {
										"id": {
											"type": "string"
										},
										"instructions": {
											"type": "array",
											"items": {
												"anyOf": [
													{
														"anyOf": [
															{
																"type": "object",
																"properties": {
																	"kind": {
																		"type": "string",
																		"const": "assign"
																	},
																	"target": {
																		"type": "string"
																	},
																	"value": {
																		"$ref": "#/$defs/EirExpr"
																	}
																},
																"additionalProperties": false,
																"required": [
																	"kind",
																	"target",
																	"value"
																]
															},
															{
																"type": "object",
																"properties": {
																	"args": {
																		"type": "array",
																		"items": {
																			"type": "string"
																		}
																	},
																	"kind": {
																		"type": "string",
																		"const": "op"
																	},
																	"name": {
																		"type": "string"
																	},
																	"ns": {
																		"type": "string"
																	},
																	"target": {
																		"type": "string"
																	}
																},
																"additionalProperties": false,
																"required": [
																	"kind",
																	"target",
																	"ns",
																	"name",
																	"args"
																]
															},
															{
																"$ref": "spiral.schema.json#/$defs/LirInsPhi"
															},
															{
																"type": "object",
																"properties": {
																	"args": {
																		"type": "array",
																		"items": {
																			"type": "string"
																		}
																	},
																	"kind": {
																		"type": "string",
																		"const": "effect"
																	},
																	"op": {
																		"type": "string"
																	},
																	"target": {
																		"type": "string"
																	}
																},
																"additionalProperties": false,
																"required": [
																	"kind",
																	"target",
																	"op",
																	"args"
																]
															},
															{
																"type": "object",
																"properties": {
																	"kind": {
																		"type": "string",
																		"const": "assignRef"
																	},
																	"target": {
																		"type": "string"
																	},
																	"value": {
																		"type": "string"
																	}
																},
																"additionalProperties": false,
																"required": [
																	"kind",
																	"target",
																	"value"
																]
															}
														]
													},
													{
														"type": "object",
														"properties": {
															"args": {
																"type": "array",
																"items": {
																	"type": "string"
																}
															},
															"entry": {
																"type": "string"
															},
															"kind": {
																"type": "string",
																"const": "spawn"
															},
															"target": {
																"type": "string"
															}
														},
														"additionalProperties": false,
														"required": [
															"kind",
															"target",
															"entry"
														]
													},
													{
														"type": "object",
														"properties": {
															"channel": {
																"type": "string"
															},
															"kind": {
																"type": "string",
																"const": "channelOp"
															},
															"op": {
																"type": "string",
																"enum": [
																	"send",
																	"recv",
																	"trySend",
																	"tryRecv"
																]
															},
															"target": {
																"type": "string"
															},
															"value": {
																"type": "string"
															}
														},
														"additionalProperties": false,
														"required": [
															"kind",
															"op",
															"channel"
														]
													},
													{
														"type": "object",
														"properties": {
															"future": {
																"type": "string"
															},
															"kind": {
																"type": "string",
																"const": "await"
															},
															"target": {
																"type": "string"
															}
														},
														"additionalProperties": false,
														"required": [
															"kind",
															"target",
															"future"
														]
													}
												]
											}
										},
										"terminator": {
											"anyOf": [
												{
													"$ref": "spiral.schema.json#/$defs/LirTermJump"
												},
												{
													"$ref": "spiral.schema.json#/$defs/LirTermBranch"
												},
												{
													"$ref": "spiral.schema.json#/$defs/LirTermReturn"
												},
												{
													"$ref": "spiral.schema.json#/$defs/LirTermExit"
												},
												{
													"type": "object",
													"properties": {
														"branches": {
															"type": "array",
															"items": {
																"type": "object",
																"properties": {
																	"block": {
																		"type": "string"
																	},
																	"taskId": {
																		"type": "string"
																	}
																},
																"additionalProperties": false,
																"required": [
																	"block",
																	"taskId"
																]
															}
														},
														"continuation": {
															"type": "string"
														},
														"kind": {
															"type": "string",
															"const": "fork"
														}
													},
													"additionalProperties": false,
													"required": [
														"kind",
														"branches",
														"continuation"
													]
												},
												{
													"type": "object",
													"properties": {
														"kind": {
															"type": "string",
															"const": "join"
														},
														"results": {
															"type": "array",
															"items": {
																"type": "string"
															}
														},
														"tasks": {
															"type": "array",
															"items": {
																"type": "string"
															}
														},
														"to": {
															"type": "string"
														}
													},
													"additionalProperties": false,
													"required": [
														"kind",
														"tasks",
														"to"
													]
												},
												{
													"type": "object",
													"properties": {
														"future": {
															"type": "string"
														},
														"kind": {
															"type": "string",
															"const": "suspend"
														},
														"resumeBlock": {
															"type": "string"
														}
													},
													"additionalProperties": false,
													"required": [
														"kind",
														"future",
														"resumeBlock"
													]
												}
											]
										}
									},
									"additionalProperties": false,
									"required": [
										"id",
										"instructions",
										"terminator"
									]
								}
							},
							"entry": {
								"type": "string"
							},
							"id": {
								"type": "string"
							}
						},
						"additionalProperties": false,
						"required": [
							"id",
							"blocks",
							"entry"
						]
					}
				]
			}
		},
		"result": {
			"type": "string"
		},
		"version": {
			"type": "string",
			"pattern": "^\\d+\\.\\d+\\.\\d+(-[a-zA-Z0-9.]+)?$"
		}
	},
	"additionalProperties": false,
	"required": [
		"version",
		"nodes",
		"result"
	]
}
